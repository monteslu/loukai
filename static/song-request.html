<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loukai Karaoke - Song Requests</title>
    <style>
        /* Material Icons Font */
        @font-face {
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: 400;
            src: url('/static/fonts/material-icons.woff2') format('woff2');
            font-display: swap;
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Header */
        .header {
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .header .subtitle {
            color: #999;
            font-size: 0.9rem;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }



        /* Songs List */
        .songs-section {
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            overflow: hidden;
        }

        .section-header {
            padding: 15px 20px;
            background: #333;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .songs-count {
            color: #999;
            font-size: 0.9rem;
        }

        .songs-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .songs-list::-webkit-scrollbar {
            width: 8px;
        }

        .songs-list::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .songs-list::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }

        .songs-list::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
            cursor: pointer;
        }

        .song-item:hover {
            background: #333;
        }

        .song-item:last-child {
            border-bottom: none;
        }

        .song-info {
            flex: 1;
        }

        .song-title {
            font-size: 1rem;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .song-artist {
            font-size: 0.9rem;
            color: #999;
        }

        .song-duration {
            color: #666;
            font-size: 0.9rem;
            margin-right: 15px;
        }

        .request-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .request-btn:hover {
            background: #0066aa;
        }

        .request-btn:disabled {
            background: #4a4a4a;
            color: #999;
            cursor: not-allowed;
        }

        /* Request Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #3a3a3a;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .modal-song-info {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background: #333;
            border-radius: 6px;
            border-left: 4px solid #007acc;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            color: #ffffff;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #007acc;
            color: white;
        }

        .btn-primary:hover {
            background: #0066aa;
        }

        .btn-secondary {
            background: #4a4a4a;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a5a5a;
        }

        /* Quick Search Section */
        .quick-search-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #3a3a3a;
            position: relative;
        }

        .quick-search-title {
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
        }

        .quick-search-input {
            width: 100%;
            padding: 12px;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 6px;
            color: #fff;
            font-size: 1rem;
        }

        .quick-search-input:focus {
            outline: none;
            border-color: #007bff;
            background: #444;
        }

        .quick-search-dropdown {
            position: absolute;
            top: 100%;
            left: 15px;
            right: 15px;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .quick-search-item {
            padding: 12px;
            border-bottom: 1px solid #4a4a4a;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-search-item:last-child {
            border-bottom: none;
        }

        .quick-search-item:hover {
            background: #4a4a4a;
        }

        .quick-search-song-info {
            flex: 1;
        }

        .quick-search-title-text {
            font-weight: bold;
            color: #fff;
            margin-bottom: 2px;
        }

        .quick-search-artist {
            color: #ccc;
            font-size: 0.9rem;
        }

        .quick-search-request-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .quick-search-request-btn:hover {
            background: #0056b3;
        }

        /* Alphabet Navigation */
        .alphabet-nav {
            margin: 15px 0;
            padding: 15px;
            background: #3a3a3a;
            border-radius: 6px;
            border: 1px solid #4a4a4a;
        }

        .alphabet-title {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .alphabet-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .alphabet-btn {
            background: #4a4a4a;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s;
            min-width: 36px;
            text-align: center;
        }

        .alphabet-btn:hover {
            background: #007bff;
        }

        .alphabet-btn.active {
            background: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }

        .alphabet-btn.disabled {
            background: #2a2a2a;
            color: #666;
            cursor: not-allowed;
        }

        /* Page Navigation */
        .page-nav {
            margin: 15px 0;
            padding: 10px;
            background: #3a3a3a;
            border-radius: 6px;
            border: 1px solid #4a4a4a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .page-info {
            color: #ccc;
            font-size: 0.9rem;
        }

        .page-buttons {
            display: flex;
            gap: 5px;
        }

        .page-btn {
            background: #4a4a4a;
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            min-width: 32px;
        }

        .page-btn:hover {
            background: #007bff;
        }

        .page-btn.active {
            background: #007bff;
        }

        .page-btn:disabled {
            background: #2a2a2a;
            color: #666;
            cursor: not-allowed;
        }

        /* Queue Section */
        .queue-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #3a3a3a;
        }

        .queue-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .queue-list {
            list-style: none;
        }

        .queue-item {
            padding: 12px;
            background: #333;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-position {
            background: #4a4a4a;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .queue-info {
            flex: 1;
        }

        .queue-requester {
            color: #007acc;
            font-size: 0.85rem;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #3a3a3a;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-success {
            background: #1a4a1a;
            border: 1px solid #2a5a2a;
            color: #4ade80;
        }

        .message-error {
            background: #4a1a1a;
            border: 1px solid #5a2a2a;
            color: #f87171;
        }

        .message-info {
            background: #1a3a4a;
            border: 1px solid #2a4a5a;
            color: #60a5fa;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .admin-link {
                position: static;
                margin: 10px;
                width: calc(100% - 20px);
                justify-content: center;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .songs-list {
                max-height: 400px;
            }
        }

        /* Name Prompt Modal */
        .name-prompt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .name-prompt-modal {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid #444;
        }

        .name-prompt-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #ffffff;
        }

        .name-prompt-subtitle {
            color: #cccccc;
            margin-bottom: 2rem;
            line-height: 1.4;
        }

        .name-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 8px;
            background: #1a1a1a;
            color: #ffffff;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .name-input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .name-submit-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
        }

        .name-submit-btn:hover {
            background: #0056CC;
        }

        .name-submit-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .main-content {
            display: none;
        }

        .main-content.visible {
            display: block;
        }

        .requester-display {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #ffffff;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <!-- Name Prompt Modal -->
    <div id="namePromptOverlay" class="name-prompt-overlay">
        <div class="name-prompt-modal">
            <div class="name-prompt-title">Welcome to Karaoke!</div>
            <div class="name-prompt-subtitle">Please enter your name to request songs</div>
            <input type="text"
                   id="nameInput"
                   class="name-input"
                   placeholder="Your name..."
                   maxlength="50"
                   autocomplete="off">
            <button id="nameSubmitBtn" class="name-submit-btn" disabled>Continue</button>
        </div>
    </div>

    <!-- Main Content (initially hidden) -->
    <div id="mainContent" class="main-content">

    <!-- Header -->
    <div class="header">
        <h1 id="serverName">Loukai Karaoke</h1>
        <div class="subtitle">Request your favorite songs!</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Quick Search Section -->
        <div class="quick-search-section">
            <div class="quick-search-title">
                <span class="material-icons">search</span>
                <span>Quick Song Search</span>
            </div>
            <input
                type="text"
                id="quickSearchInput"
                class="quick-search-input"
                placeholder="Search songs to request..."
                autocomplete="off"
            >
            <div id="quickSearchDropdown" class="quick-search-dropdown"></div>
        </div>

        <!-- Songs Section -->
        <div class="songs-section">
            <div class="section-header">
                <div class="section-title">Available Songs</div>
                <div class="songs-count" id="songsCount">0 songs</div>
            </div>

            <!-- Alphabet Navigation -->
            <div class="alphabet-nav" id="alphabetNav">
                <div class="alphabet-title">Browse by Artist:</div>
                <div class="alphabet-buttons" id="alphabetButtons">
                    <!-- Will be populated with available letters -->
                </div>
            </div>

            <!-- Page Navigation -->
            <div class="page-nav" id="pageNav" style="display: none;">
                <div class="page-info" id="pageInfo"></div>
                <div class="page-buttons" id="pageButtons"></div>
            </div>
            <div class="songs-list" id="songsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading songs...</div>
                </div>
            </div>
        </div>

        <!-- Queue Section -->
        <div class="queue-section">
            <div class="queue-title">
                <span class="material-icons">queue_music</span>
                <span>Current Queue</span>
            </div>
            <ul class="queue-list" id="queueList">
                <li class="queue-item">
                    <div style="display: flex; align-items: center;">
                        <div class="queue-position">1</div>
                        <div class="queue-info">
                            <div class="song-title">Loading queue...</div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Request Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Request Song</h2>
                <div class="modal-song-info" id="modalSongInfo"></div>
            </div>

            <form id="requestForm">
                <div class="form-group">
                    <label class="form-label">Requesting as:</label>
                    <div class="requester-display" id="requesterDisplay"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="message">Message (optional)</label>
                    <textarea id="message"
                              class="form-input form-textarea"
                              maxlength="200"
                              placeholder="Add a message or dedication..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeRequestModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let allSongs = [];
        let filteredSongs = [];
        let quickSearchSongs = []; // Store current quick search results
        let selectedSong = null;
        let serverSettings = {};
        let userName = null;
        let socket = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupNamePrompt();
            initializeSocket();
        });

        function setupNamePrompt() {
            // Check if name is already stored
            const storedName = localStorage.getItem('karaoke-user-name');
            if (storedName && storedName.trim()) {
                userName = storedName.trim();
                showMainContent();
            } else {
                showNamePrompt();
            }

            // Setup name prompt event listeners
            const nameInput = document.getElementById('nameInput');
            const nameSubmitBtn = document.getElementById('nameSubmitBtn');

            nameInput.addEventListener('input', (e) => {
                const name = e.target.value.trim();
                nameSubmitBtn.disabled = name.length === 0;
            });

            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && nameInput.value.trim()) {
                    submitName();
                }
            });

            nameSubmitBtn.addEventListener('click', submitName);
        }

        function submitName() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();

            if (name) {
                userName = name;
                localStorage.setItem('karaoke-user-name', name);
                showMainContent();
            }
        }

        function showNamePrompt() {
            document.getElementById('namePromptOverlay').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('visible');
            // Focus the input after a brief delay
            setTimeout(() => {
                document.getElementById('nameInput').focus();
            }, 100);
        }

        function showMainContent() {
            document.getElementById('namePromptOverlay').style.display = 'none';
            document.getElementById('mainContent').classList.add('visible');

            // Initialize the main application
            loadServerInfo();
            loadSongs();
            loadQueue();
            setupEventListeners();

            // Refresh queue every 10 seconds
            setInterval(loadQueue, 10000);
        }

        // Load server info
        async function loadServerInfo() {
            try {
                const response = await fetch('/api/info');
                const info = await response.json();

                serverSettings = info;
                document.getElementById('serverName').textContent = info.serverName || 'Karaoke';
                document.title = `${info.serverName || 'Karaoke'} - Song Requests`;

                if (!info.allowRequests) {
                    showMessage('Song requests are currently disabled', 'info');
                }
            } catch (error) {
                console.error('Failed to load server info:', error);
            }
        }

        // Load songs
        // Pagination state
        let currentLetter = '';
        let currentPage = 1;
        let availableLetters = [];

        // Load available letters and setup alphabet navigation
        async function loadSongs() {
            try {
                const response = await fetch('/api/letters');
                const data = await response.json();

                availableLetters = data.letters || [];

                // Create alphabet buttons
                createAlphabetButtons(availableLetters);

                // Load first available letter by default (A if available)
                const firstLetter = availableLetters.includes('A') ? 'A' : availableLetters[0];
                if (firstLetter) {
                    loadLetterPage(firstLetter, 1);
                }
            } catch (error) {
                console.error('Failed to load songs:', error);
                document.getElementById('songsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon material-icons">error_outline</div>
                        <div>Failed to load songs. Please refresh the page.</div>
                    </div>
                `;
            }
        }

        function createAlphabetButtons(availableLetters) {
            const buttonsContainer = document.getElementById('alphabetButtons');
            const allLetters = [...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), '#'];

            buttonsContainer.innerHTML = allLetters.map(letter => {
                const hasContent = availableLetters.includes(letter);
                const classes = hasContent ? 'alphabet-btn' : 'alphabet-btn disabled';
                return `<button class="${classes}" ${hasContent ? `onclick="loadLetterPage('${letter}', 1)"` : 'disabled'}>${letter}</button>`;
            }).join('');
        }

        // Display songs
        function displaySongs() {
            const container = document.getElementById('songsList');

            if (filteredSongs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon material-icons">library_music</div>
                        <div>No songs found</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredSongs.map(song => `
                <div class="song-item" onclick="requestSong('${song.id.replace(/'/g, "\\'")}')">
                    <div class="song-info">
                        <div class="song-title">${getFormatIcon(song.format)} ${escapeHtml(song.title)}</div>
                        <div class="song-artist">${escapeHtml(song.artist)}</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span class="song-duration">${formatDuration(song.duration)}</span>
                        <button class="request-btn" ${!serverSettings.allowRequests ? 'disabled' : ''}>
                            <span class="material-icons" style="font-size: 18px;">add</span>
                            Request
                        </button>
                    </div>
                </div>
            `).join('');
        }


        // Load queue
        async function loadQueue() {
            try {
                const response = await fetch('/api/queue');
                const data = await response.json();

                displayQueue(data.queue || []);

                if (data.currentlyPlaying) {
                    // Could show currently playing song somewhere
                }
            } catch (error) {
                console.error('Failed to load queue:', error);
            }
        }

        // Display queue
        function displayQueue(queue) {
            const container = document.getElementById('queueList');

            if (queue.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon material-icons">queue_music</div>
                        <div>Queue is empty</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = queue.map((item, index) => `
                <li class="queue-item">
                    <div style="display: flex; align-items: center;">
                        <div class="queue-position">${index + 1}</div>
                        <div class="queue-info">
                            <div class="song-title">${escapeHtml(item.title)}</div>
                            <div class="song-artist">${escapeHtml(item.artist)}</div>
                            <div class="queue-requester">Requested by ${escapeHtml(item.requester)}</div>
                        </div>
                    </div>
                </li>
            `).join('');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Quick Search
            const quickSearchInput = document.getElementById('quickSearchInput');
            if (quickSearchInput) {
                quickSearchInput.addEventListener('input', handleQuickSearch);
                quickSearchInput.addEventListener('focus', () => {
                    if (quickSearchInput.value.trim()) {
                        showQuickSearchDropdown();
                    }
                });
                quickSearchInput.addEventListener('blur', () => {
                    setTimeout(hideQuickSearchDropdown, 150);
                });
            }

            // Request form
            document.getElementById('requestForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitRequest();
            });

            // Modal close on background click
            document.getElementById('requestModal').addEventListener('click', (e) => {
                if (e.target.id === 'requestModal') {
                    closeRequestModal();
                }
            });
        }

        // Request song
        function requestSong(songId) {
            if (!serverSettings.allowRequests) {
                showMessage('Song requests are currently disabled', 'info');
                return;
            }

            selectedSong = filteredSongs.find(s => s.id === songId);
            if (!selectedSong) {
                console.error('Song not found for request:', songId);
                return;
            }

            showRequestModal(selectedSong);
        }

        // Close modal
        function closeRequestModal() {
            document.getElementById('requestModal').classList.remove('active');
            document.getElementById('requestForm').reset();
            selectedSong = null;
        }

        // Submit request
        async function submitRequest() {
            if (!selectedSong) return;

            const message = document.getElementById('message').value.trim();

            if (!userName) {
                showMessage('Please refresh the page and enter your name', 'error');
                return;
            }

            console.log('ðŸŽ¤ Submitting request for:', selectedSong.id, 'by', userName);

            try {
                const requestData = {
                    songId: selectedSong.id,
                    requesterName: userName,
                    message
                };

                console.log('ðŸ“¤ Request data:', requestData);

                const response = await fetch('/api/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                console.log('ðŸ“¥ Response status:', response.status);
                const result = await response.json();
                console.log('ðŸ“¥ Response data:', result);

                if (result.success) {
                    console.log('âœ… Request successful:', result.message);
                    showMessage(result.message || 'Song requested successfully!', 'success');
                    closeRequestModal();

                    // Reload queue after a moment
                    setTimeout(loadQueue, 1000);
                } else {
                    console.error('âŒ Request failed:', result.error);
                    showMessage(result.error || 'Failed to submit request', 'error');
                }
            } catch (error) {
                console.error('âŒ Request error:', error);
                showMessage('Failed to submit request. Please try again.', 'error');
            }
        }

        // Show message
        function showMessage(text, type = 'info') {
            // Remove existing messages
            document.querySelectorAll('.message').forEach(msg => msg.remove());

            const message = document.createElement('div');
            message.className = `message message-${type}`;

            const icon = type === 'success' ? 'check_circle' :
                         type === 'error' ? 'error' : 'info';

            message.innerHTML = `
                <span class="material-icons">${icon}</span>
                <span>${text}</span>
            `;

            document.querySelector('.container').insertBefore(
                message,
                document.querySelector('.songs-section')
            );

            // Auto remove after 5 seconds
            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        // Update song count
        function updateSongCount() {
            const count = filteredSongs.length;
            const total = allSongs.length;

            let text = `${count} song${count !== 1 ? 's' : ''}`;
            if (count !== total) {
                text += ` (of ${total})`;
            }

            document.getElementById('songsCount').textContent = text;
        }

        // Socket.IO connection
        function initializeSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('Connected to server');
                // Identify as web-ui client
                socket.emit('identify', { type: 'web-ui' });
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
            });

            // Listen for queue updates
            socket.on('queue-update', (queueData) => {
                updateQueueDisplay(queueData);
            });

            // Listen for player state updates
            socket.on('player-state-update', (state) => {
                updatePlayerStateDisplay(state);
            });

            // Listen for settings updates
            socket.on('settings-update', (settings) => {
                serverSettings = settings;
                updateUIBasedOnSettings();
            });

            // Listen for song changes
            socket.on('song-changed', (songData) => {
                handleSongChanged(songData);
            });

            // Listen for library refresh notifications
            socket.on('library-refreshed', (data) => {
                console.log('ðŸ“š Library refreshed on server:', data);
                // Reload the alphabet navigation
                loadSongs();
            });

        }

        function updateQueueDisplay(queueData) {
            // Update the current queue display if it exists
            console.log('Queue updated:', queueData);
            // You can add UI elements to show current queue here
        }

        function updatePlayerStateDisplay(state) {
            // Update player state display if needed
            console.log('Player state updated:', state);
            // You can add UI elements to show current playing song here
        }

        function updateUIBasedOnSettings() {
            // Update UI based on server settings
            console.log('Settings updated:', serverSettings);
            // This could disable/enable request functionality based on settings
        }



        function handleSongChanged(songData) {
            console.log('Song changed:', songData);
            // Update UI to show current song info
            updateCurrentSongDisplay(songData);
        }

        function updateCurrentSongDisplay(songData) {
            // You can add UI elements here to show the currently playing song
            console.log(`Now playing: ${songData.title} - ${songData.artist}`);
        }

        // Helper functions
        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function getFormatIcon(format) {
            switch (format) {
                case 'kai':
                    return 'âš¡';
                case 'cdg-archive':
                case 'cdg-pair':
                    return 'ðŸ’¿';
                default:
                    return 'âš¡';
            }
        }

        // Quick Search Functions
        async function handleQuickSearch(e) {
            const searchTerm = e.target.value.trim();
            const dropdown = document.getElementById('quickSearchDropdown');

            if (!searchTerm) {
                hideQuickSearchDropdown();
                return;
            }

            try {
                const response = await fetch(`/api/songs?search=${encodeURIComponent(searchTerm)}&limit=8`);
                const data = await response.json();

                if (data.songs && data.songs.length > 0) {
                    displayQuickSearchResults(data.songs);
                    showQuickSearchDropdown();
                } else {
                    dropdown.innerHTML = '<div class="quick-search-item">No songs found</div>';
                    showQuickSearchDropdown();
                }
            } catch (error) {
                console.error('Quick search error:', error);
                dropdown.innerHTML = '<div class="quick-search-item">Search error</div>';
                showQuickSearchDropdown();
            }
        }

        function displayQuickSearchResults(songs) {
            // Store the songs for quick access
            quickSearchSongs = songs;

            const dropdown = document.getElementById('quickSearchDropdown');
            dropdown.innerHTML = songs.map((song, index) => `
                <div class="quick-search-item">
                    <div class="quick-search-song-info">
                        <div class="quick-search-title-text">${escapeHtml(song.title)}</div>
                        <div class="quick-search-artist">${escapeHtml(song.artist)}</div>
                    </div>
                    <button class="quick-search-request-btn" onclick="requestSongFromQuickSearch(${index})">
                        Request
                    </button>
                </div>
            `).join('');
        }

        function showQuickSearchDropdown() {
            const dropdown = document.getElementById('quickSearchDropdown');
            if (dropdown) {
                dropdown.style.display = 'block';
            }
        }

        function hideQuickSearchDropdown() {
            const dropdown = document.getElementById('quickSearchDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function requestSongFromQuickSearch(songIndex) {
            if (!serverSettings.allowRequests) {
                showMessage('Song requests are currently disabled', 'info');
                return;
            }

            hideQuickSearchDropdown();
            document.getElementById('quickSearchInput').value = '';

            // Get the song from stored quick search results
            const song = quickSearchSongs[songIndex];
            if (song) {
                showRequestModal(song);
            } else {
                console.error('Song not found at index:', songIndex);
                showMessage('Song not found', 'error');
            }
        }

        function showRequestModal(song) {
            selectedSong = song;

            // Show modal with song info
            document.getElementById('modalSongInfo').textContent =
                `${song.title} - ${song.artist}`;

            // Show the user's name
            document.getElementById('requesterDisplay').textContent = userName;

            document.getElementById('requestModal').classList.add('active');

            // Focus message input
            setTimeout(() => {
                document.getElementById('message').focus();
            }, 100);
        }

        async function loadLetterPage(letter, page = 1) {
            currentLetter = letter;
            currentPage = page;

            // Update active alphabet button
            document.querySelectorAll('.alphabet-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.alphabet-btn[onclick*="'${letter}'"]`)?.classList.add('active');

            try {
                // Show loading
                document.getElementById('songsList').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Loading songs...</div>
                    </div>
                `;

                // Fetch songs for this letter and page (encode # as %23)
                const response = await fetch(`/api/songs/letter/${encodeURIComponent(letter)}?page=${page}&limit=100`);
                const data = await response.json();

                // Update display
                filteredSongs = data.songs || [];
                displaySongs();
                updateSongCount();

                // Setup pagination if needed
                if (data.pagination) {
                    setupPageNavigation(letter, data.pagination);
                }
            } catch (error) {
                console.error('Failed to load letter page:', error);
                document.getElementById('songsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon material-icons">error_outline</div>
                        <div>Failed to load songs. Please try again.</div>
                    </div>
                `;
            }
        }

        function setupPageNavigation(letter, pagination) {
            const pageNav = document.getElementById('pageNav');
            const pageInfo = document.getElementById('pageInfo');
            const pageButtons = document.getElementById('pageButtons');

            if (pagination.totalPages <= 1) {
                pageNav.style.display = 'none';
                return;
            }

            pageNav.style.display = 'flex';

            // Update page info
            const startSong = (pagination.currentPage - 1) * pagination.songsPerPage + 1;
            const endSong = Math.min(pagination.currentPage * pagination.songsPerPage, pagination.totalSongs);
            pageInfo.textContent = `Showing ${startSong}-${endSong} of ${pagination.totalSongs} songs by artists starting with "${letter}"`;

            // Create page buttons
            let buttonsHTML = '';

            // Previous button
            if (pagination.hasPreviousPage) {
                buttonsHTML += `<button class="page-btn" onclick="loadLetterPage('${letter}', ${pagination.currentPage - 1})">â€¹ Prev</button>`;
            }

            // Page number buttons (show up to 5 around current page)
            const maxButtons = 5;
            let startPage = Math.max(1, pagination.currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(pagination.totalPages, startPage + maxButtons - 1);

            // Adjust start if we're near the end
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const classes = i === pagination.currentPage ? 'page-btn active' : 'page-btn';
                buttonsHTML += `<button class="${classes}" onclick="loadLetterPage('${letter}', ${i})">${i}</button>`;
            }

            // Next button
            if (pagination.hasNextPage) {
                buttonsHTML += `<button class="page-btn" onclick="loadLetterPage('${letter}', ${pagination.currentPage + 1})">Next â€º</button>`;
            }

            pageButtons.innerHTML = buttonsHTML;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    </div> <!-- End main-content -->

</body>
</html>