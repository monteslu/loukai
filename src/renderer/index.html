<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loukai</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="dist/renderer.css">
</head>
<body>
    <div class="app-container">
        <!-- Song Info Bar - React Component -->
        <div id="react-song-info-root"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar - React Component -->
            <div class="sidebar" id="react-visualization-root"></div>

            <!-- Center Content -->
            <div class="center-content">
                <!-- Tab Navigation - React Component -->
                <div id="react-tab-nav-root"></div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Library Tab -->
                    <div id="library-tab" class="tab-pane">
                        <!-- React Library Panel will be mounted here -->
                        <div id="react-library-root"></div>
                    </div>

                    <!-- Mixer Tab - React Component -->
                    <div id="mixer-tab" class="tab-pane">
                        <!-- React MixerTab will be mounted here -->
                    </div>

                    <!-- Player Tab -->
                    <div id="player-tab" class="tab-pane active">
                        <div class="player-container">
                            <!-- Top Section: Queue Sidebar + Canvas -->
                            <div class="player-top-section">
                                <!-- Queue Sidebar (Left 1/3) - React Component -->
                                <div class="player-queue-sidebar">
                                    <div id="react-queue-root"></div>
                                </div>
                                
                                <!-- Canvas Area (Right 2/3) -->
                                <div class="player-canvas-area">
                                    <div class="karaoke-display">
                                        <canvas id="karaokeCanvas" width="1920" height="1080" style="cursor: pointer;"></canvas>
                                        <div class="lyrics-container" id="lyricsContainer" style="display: none;">
                                            <div class="no-lyrics">No lyrics available</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bottom Section: Transport Controls (Full Width) - React Component -->
                            <div id="react-transport-root"></div>
                            
                        </div>
                    </div>

                    <!-- Coaching Tab - Disabled for now -->
                    <!-- <div id="coaching-tab" class="tab-pane">
                        <div class="coaching-container">
                            <div class="pitch-display">
                                <canvas id="pitchCanvas" width="600" height="300"></canvas>
                            </div>

                            <div class="coaching-metrics">
                                <div class="metric">
                                    <label>Pitch Accuracy:</label>
                                    <div class="metric-bar">
                                        <div class="metric-fill" style="width: 0%"></div>
                                    </div>
                                    <span class="metric-value">0%</span>
                                </div>

                                <div class="metric">
                                    <label>Timing:</label>
                                    <div class="metric-bar">
                                        <div class="metric-fill" style="width: 0%"></div>
                                    </div>
                                    <span class="metric-value">0%</span>
                                </div>

                                <div class="metric">
                                    <label>Stability:</label>
                                    <div class="metric-bar">
                                        <div class="metric-fill" style="width: 0%"></div>
                                    </div>
                                    <span class="metric-value">0%</span>
                                </div>
                            </div>
                        </div>
                    </div> -->

                    <!-- Effects Tab -->
                    <div id="effects-tab" class="tab-pane">
                        <!-- React Effects Panel will be mounted here -->
                        <div id="react-effects-root"></div>
                    </div>

                    <!-- Song Requests Tab -->
                    <div id="requests-tab" class="tab-pane">
                        <!-- React Requests List will be mounted here -->
                        <div id="react-requests-root"></div>
                    </div>

                    <!-- Server Tab - React Component -->
                    <div id="server-tab" class="tab-pane">
                        <!-- React ServerTab will be mounted here -->
                    </div>

                    <!-- Lyrics Editor Tab -->
                    <div id="editor-tab" class="tab-pane">
                        <!-- React Song Editor -->
                        <div id="react-editor-root" style="height: 100%; display: flex; flex-direction: column;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar - React Component -->
        <div id="react-status-bar-root"></div>
    </div>

    <!-- Visualization Libraries -->
    <script src="lib/butterchurn.min.js"></script>
    <script src="lib/butterchurnPresets.min.js"></script>
    <script>
        console.log('Butterchurn libraries loaded:', {
            butterchurn: typeof window.butterchurn,
            presets: typeof window.butterchurnPresets
        });
        
        // Verify presets are available and debug butterchurn structure
        if (window.butterchurnPresets && typeof window.butterchurnPresets.getPresets === 'function') {
            const presets = window.butterchurnPresets.getPresets();
            console.log('SUCCESS: Butterchurn loaded with', Object.keys(presets).length, 'presets available');
        }
        
        
        // WebGL compatibility test
        try {
            const testCanvas = document.createElement('canvas');
            const testGL = testCanvas.getContext('webgl2') || testCanvas.getContext('webgl');
            console.log('WebGL context test:', {
                hasWebGL: !!testGL,
                version: testGL ? testGL.getParameter(testGL.VERSION) : 'none',
                renderer: testGL ? testGL.getParameter(testGL.RENDERER) : 'none'
            });
        } catch(e) {
            console.error('WebGL test error:', e);
        }

        // Song data listener and save functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up song data listener and save functionality...');
            
            // Listen for song data from main process
            if (window.kaiAPI) {
                window.kaiAPI.song.onData((event, songData) => {
                    console.log('Received song data for save:', songData);
                    window.currentSongData = songData;
                });
            }
            
            // Set up save button handler since renderer scripts don't execute
            const saveBtn = document.getElementById('editorSaveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', async function() {
                    console.log('Save button clicked');
                    
                    if (!window.currentSongData) {
                        console.error('No song data available to save');
                        return;
                    }
                    
                    if (!window.currentSongData.originalFilePath) {
                        console.error('No original file path available for saving');
                        return;
                    }
                    
                    try {
                        // Extract edited lyrics from the DOM using correct selectors
                        const lyricsLines = document.querySelectorAll('.lyric-line-editor');
                        const editedLyrics = [];
                        
                        lyricsLines.forEach((lineElement, index) => {
                            const textElement = lineElement.querySelector('.text-input');
                            const startTimeElement = lineElement.querySelector('.start-time');
                            const endTimeElement = lineElement.querySelector('.end-time');
                            const toggleBtn = lineElement.querySelector('.toggle-btn');
                            
                            if (textElement && startTimeElement && endTimeElement) {
                                const originalLine = window.currentSongData.lyrics[index] || {};
                                const isDisabled = toggleBtn ? toggleBtn.classList.contains('toggle-disabled') : false;
                                
                                editedLyrics.push({
                                    ...originalLine,
                                    text: textElement.value || textElement.textContent || '',
                                    start: parseFloat(startTimeElement.value) || originalLine.start || 0,
                                    end: parseFloat(endTimeElement.value) || originalLine.end || 0,
                                    disabled: isDisabled
                                });
                            }
                        });
                        
                        console.log('Extracted', editedLyrics.length, 'edited lyrics lines');
                        
                        // Update the song data with edited lyrics
                        const updatedSongData = {
                            ...window.currentSongData,
                            lyrics: editedLyrics
                        };
                        
                        console.log('Attempting to save KAI file:', window.currentSongData.originalFilePath);
                        const result = await window.kaiAPI.editor.saveKai(updatedSongData, window.currentSongData.originalFilePath);
                        
                        if (result.success) {
                            console.log('Save successful');
                            // Update the current song data cache
                            window.currentSongData = updatedSongData;
                        } else {
                            console.error('Failed to save changes:', result.error || 'Unknown error');
                        }
                    } catch (error) {
                        console.error('Error saving changes:', error.message);
                    }
                });
            } else {
                console.warn('Save button not found');
            }
        });
    </script>
    
    <!-- App Scripts -->
    <!-- settingsAPI.js removed - deprecated, use window.kaiAPI.settings instead -->
    <script type="module" src="lib/cdgraphics-wrapper.js"></script>
    <script src="js/PlayerInterface.js"></script> <!-- Base class for all players -->
    <script src="js/karaokeRenderer.js"></script>
    <script src="js/cdgPlayer.js"></script>
    <script src="js/kaiPlayer.js"></script>
    <!-- <script type="module" src="js/lyricsEditor.js"></script> --> <!-- Replaced by React SongEditor -->
    <!-- <script src="js/mixer.js"></script> --> <!-- Replaced by React MixerPanel + AudioDeviceSettings -->
    <script src="js/player.js"></script>
    <!-- <script src="js/coaching.js"></script> --> <!-- Disabled for now -->
    <!-- <script type="module" src="js/effects.js"></script> --> <!-- Replaced by React EffectsPanel -->
    <!-- <script src="js/requests.js"></script> --> <!-- Replaced by React RequestsList -->
    <!-- <script type="module" src="js/editor.js"></script> --> <!-- Replaced by React SongEditor -->
    <!-- <script type="module" src="js/library.js"></script> --> <!-- Replaced by React LibraryPanel -->
    <!-- <script type="module" src="js/queue.js"></script> --> <!-- Replaced by React QueueTab -->
    <script type="module" src="js/main.js"></script>

    <!-- React Mount Point -->
    <div id="react-root"></div>

    <!-- React Bundle (loaded after vanilla JS) -->
    <script type="module" src="dist/renderer.js"></script>
</body>
</html>