<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loukai</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Song Info Bar -->
        <div class="song-info-bar">
            <div class="song-info-left">
                <button id="hamburgerBtn" class="hamburger-btn-info">
                    <span class="material-icons">menu</span>
                </button>
            </div>
            <div class="song-info-center">
                <div class="song-info">
                    <span class="song-display">No song loaded</span>
                </div>
            </div>
            <div class="song-info-right">
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="section">
                    <h3>Waveform Options</h3>
                    <div class="waveform-controls">
                        <label class="checkbox-label">
                            <input type="checkbox" id="enableWaveforms" checked>
                            <span>Enable Waveforms</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="enableEffects" checked>
                            <span>Enable Background Effects</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="randomEffectOnSong">
                            <span>Random Effect on New Song</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="showUpcomingLyrics" checked>
                            <span>Show Upcoming Lyrics</span>
                        </label>
                        <div class="slider-control">
                            <label>Overlay Opacity: <span id="overlayOpacityValue">0.50</span></label>
                            <input type="range" id="overlayOpacity" min="0" max="1" step="0.01" value="0.5">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>Auto-Tune</h3>
                    <div class="autotune-controls">
                        <label class="checkbox-label">
                            <input type="checkbox" id="autotuneEnabled">
                            <span>Enable Auto-Tune</span>
                        </label>
                        <div class="slider-group">
                            <label>Strength:</label>
                            <input type="range" id="autotuneStrength" min="0" max="100" value="50">
                            <span class="slider-value">50%</span>
                        </div>
                        <div class="slider-group">
                            <label>Speed:</label>
                            <input type="range" id="autotuneSpeed" min="1" max="100" value="20">
                            <span class="slider-value">20</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Content -->
            <div class="center-content">
                <!-- Tab Navigation -->
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="player">Player</button>
                    <button class="tab-btn" data-tab="library">Library</button>
                    <button class="tab-btn" data-tab="mixer">Audio Settings</button>
                    <button class="tab-btn" data-tab="coaching">Coaching</button>
                    <button class="tab-btn" data-tab="effects">Effects</button>
                    <button class="tab-btn" data-tab="requests">
                        Song Requests
                        <span id="requestsBadge" class="tab-badge" style="display: none;">0</span>
                    </button>
                    <button class="tab-btn" data-tab="server">Server</button>
                    <button class="tab-btn" data-tab="editor">Lyrics Editor</button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Library Tab -->
                    <div id="library-tab" class="tab-pane">
                        <div class="library-container">
                            <div class="library-header">
                                <div class="library-controls">
                                    <button id="setSongsFolderBtn" class="library-btn">
                                        üìÅ Set Songs Folder
                                    </button>
                                    <button id="refreshLibraryBtn" class="library-btn">
                                        ‚Üª Refresh
                                    </button>
                                    <div class="library-search">
                                        <input type="text" id="librarySearch" placeholder="Search songs..." />
                                    </div>
                                </div>
                                <div class="library-info">
                                    <span id="librarySongsCount">0 songs</span>
                                    <span id="libraryPath"></span>
                                </div>
                            </div>
                            
                            <div class="library-content">
                                <div id="libraryTable" class="library-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th class="col-title">Title</th>
                                                <th class="col-artist">Artist</th>
                                                <th class="col-genre">Genre</th>
                                                <th class="col-key">Key</th>
                                                <th class="col-duration">Duration</th>
                                                <th class="col-stems">Stems</th>
                                                <th class="col-actions">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="libraryTableBody">
                                            <tr class="library-empty-row">
                                                <td colspan="7">
                                                    <div class="library-empty">
                                                        <div class="empty-icon">üéµ</div>
                                                        <div class="empty-message">No songs library set</div>
                                                        <div class="empty-detail">Click "Set Songs Folder" to choose your music library</div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mixer Tab -->
                    <div id="mixer-tab" class="tab-pane">
                        <div class="mixer-container">
                            <div id="mixerStrips" class="mixer-strips">
                                <div class="no-song-message">
                                    Load a KAI file to see mixer controls
                                </div>
                            </div>

                            <!-- Audio Device Settings -->
                            <div class="audio-settings-section">
                                <h3>Audio Devices <button id="refreshDevicesBtn" class="refresh-btn">‚Üª</button></h3>
                                <div class="device-selector">
                                    <label>PA Output:</label>
                                    <select id="paDeviceSelect"></select>
                                </div>
                                <div class="device-selector">
                                    <label>IEM Output:</label>
                                    <select id="iemDeviceSelect"></select>
                                </div>
                                <div class="device-selector">
                                    <label>
                                        <input type="checkbox" id="iemMonoVocals" checked>
                                        IEM Vocals in Mono (for single earpiece)
                                    </label>
                                </div>
                            </div>

                            <!-- Mic Options -->
                            <div class="audio-settings-section">
                                <h3>Mic Options</h3>
                                <div class="device-selector">
                                    <label>Mic Input:</label>
                                    <select id="inputDeviceSelect"></select>
                                </div>
                                <div class="waveform-controls">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="micToSpeakers" checked>
                                        <span>Mic to Speakers</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="enableMic" checked>
                                        <span>Enable Mic</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Player Tab -->
                    <div id="player-tab" class="tab-pane active">
                        <div class="player-container">
                            <!-- Top Section: Queue Sidebar + Canvas -->
                            <div class="player-top-section">
                                <!-- Queue Sidebar (Left 1/3) -->
                                <div class="player-queue-sidebar">
                                    <!-- Queue Display -->
                                    <div class="player-queue-section">
                                        <!-- Quick Library Search -->
                                        <div class="quick-search-controls">
                                            <input type="text" id="quickLibrarySearch" placeholder="Search..." />
                                            <div class="quick-search-dropdown" id="quickSearchResults" style="display: none;">
                                                <div class="no-search-message">Type to search your library</div>
                                            </div>
                                        </div>
                                        
                                        <div class="player-queue-header">
                                            <h4>Queue</h4>
                                            <div class="queue-actions">
                                                <button id="playerClearQueueBtn" class="queue-action-btn" title="Clear Queue">üóëÔ∏è</button>
                                                <button id="playerShuffleQueueBtn" class="queue-action-btn" title="Shuffle">üîÄ</button>
                                            </div>
                                        </div>
                                        <div class="player-queue-list" id="playerQueueList">
                                            <div class="player-queue-empty">
                                                <div class="empty-icon">üéµ</div>
                                                <div class="empty-message">Queue is empty</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Canvas Area (Right 2/3) -->
                                <div class="player-canvas-area">
                                    <div class="karaoke-display">
                                        <canvas id="karaokeCanvas" width="1920" height="1080" style="cursor: pointer;"></canvas>
                                        <div class="lyrics-container" id="lyricsContainer" style="display: none;">
                                            <div class="no-lyrics">No lyrics available</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bottom Section: Transport Controls (Full Width) -->
                            <div class="transport-extended">
                                <div id="playControls">
                                    <button id="restartBtn" title="Restart Track">
                                        <span class="material-icons">replay</span>
                                    </button>
                                    <button id="playPauseBtn" title="Play/Pause">‚ñ∂</button>
                                    <button id="nextTrackBtn" title="Next Track">
                                        <span class="material-icons">skip_next</span>
                                    </button>
                                    
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="progressFill"></div>
                                            <div class="progress-handle" id="progressHandle"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="time-display">
                                        <span id="currentTime">0:00</span>
                                        <span>/</span>
                                        <span id="totalTime">0:00</span>
                                    </div>
                                </div>
                                
                                <div class="effects-controls">
                                    <button id="prevEffectBtn" title="Previous Effect">‚óÄ FX</button>
                                    <span id="currentEffectName">Effect</span>
                                    <button id="nextEffectBtn" title="Next Effect">FX ‚ñ∂</button>
                                    <button id="openCanvasWindowBtn" class="icon-btn" title="Open Canvas Window">
                                        <span class="material-icons">open_in_new</span>
                                    </button>
                                </div>
                            </div>
                            
                        </div>
                    </div>

                    <!-- Coaching Tab -->
                    <div id="coaching-tab" class="tab-pane">
                        <div class="coaching-container">
                            <div class="pitch-display">
                                <canvas id="pitchCanvas" width="600" height="300"></canvas>
                            </div>
                            
                            <div class="coaching-metrics">
                                <div class="metric">
                                    <label>Pitch Accuracy:</label>
                                    <div class="metric-bar">
                                        <div class="metric-fill" style="width: 0%"></div>
                                    </div>
                                    <span class="metric-value">0%</span>
                                </div>
                                
                                <div class="metric">
                                    <label>Timing:</label>
                                    <div class="metric-bar">
                                        <div class="metric-fill" style="width: 0%"></div>
                                    </div>
                                    <span class="metric-value">0%</span>
                                </div>
                                
                                <div class="metric">
                                    <label>Stability:</label>
                                    <div class="metric-bar">
                                        <div class="metric-fill" style="width: 0%"></div>
                                    </div>
                                    <span class="metric-value">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Effects Tab -->
                    <div id="effects-tab" class="tab-pane">
                        <div class="effects-container">
                            <div class="effects-header">
                                <div class="effects-search">
                                    <input type="text" id="effectsSearch" placeholder="Search effects..." />
                                </div>
                                <div class="effects-info">
                                    <span id="effectsCount">0 effects</span>
                                    <button id="randomEffectBtn" class="effects-btn">üé≤ Random</button>
                                </div>
                            </div>
                            
                            <div class="effects-content">
                                <div class="effects-categories">
                                    <button class="category-btn active" data-category="all">All</button>
                                    <button class="category-btn" data-category="geiss">Geiss</button>
                                    <button class="category-btn" data-category="martin">Martin</button>
                                    <button class="category-btn" data-category="flexi">Flexi</button>
                                    <button class="category-btn" data-category="shifter">Shifter</button>
                                    <button class="category-btn" data-category="other">Other</button>
                                </div>
                                
                                <div class="effects-list" id="effectsList">
                                    <div class="effects-loading">
                                        <div class="loading-icon">‚è≥</div>
                                        <div class="loading-message">Loading Butterchurn effects...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Song Requests Tab -->
                    <div id="requests-tab" class="tab-pane">
                        <div class="requests-container">
                            <div class="requests-header">
                                <div class="server-status">
                                    <h3>üåê Web Server</h3>
                                    <p id="serverUrl">Server not started</p>
                                    <button id="copyUrlBtn" class="requests-btn" style="display: none;">üìã Copy URL</button>
                                </div>
                                <div class="requests-settings">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="allowRequestsToggle" checked>
                                        <span>Allow Song Requests</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="requireApprovalToggle" checked>
                                        <span>Require KJ Approval</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="requests-content">
                                <div class="requests-section">
                                    <div class="requests-section-header">
                                        <h4>üìù Pending Requests</h4>
                                        <button id="refreshRequestsBtn" class="requests-btn">üîÑ Refresh</button>
                                    </div>
                                    <div id="pendingRequestsList" class="requests-list">
                                        <div class="no-requests">No pending requests</div>
                                    </div>
                                </div>
                                
                                <div class="requests-section">
                                    <div class="requests-section-header">
                                        <h4>‚úÖ Recent Activity</h4>
                                        <button id="clearHistoryBtn" class="requests-btn">üóëÔ∏è Clear</button>
                                    </div>
                                    <div id="requestHistoryList" class="requests-list">
                                        <div class="no-requests">No recent activity</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Server Tab -->
                    <div id="server-tab" class="tab-pane">
                        <div class="server-container">
                            <div class="server-header">
                                <h2>Web Server Settings</h2>
                                <div class="server-status" id="serverStatus">
                                    <span class="status-indicator offline" id="statusIndicator"></span>
                                    <span id="serverStatusText">Checking...</span>
                                </div>
                            </div>

                            <div class="server-content">
                                <!-- Server Control -->
                                <div class="server-section">
                                    <h3>Server Control</h3>
                                    <div class="server-controls">
                                        <div class="control-row">
                                            <label>Server Status:</label>
                                            <div class="control-group">
                                                <span id="serverUrl">Not running</span>
                                                <button id="openServerBtn" class="action-btn" disabled>
                                                    <span class="material-icons">open_in_new</span>
                                                    Open in Browser
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Server Settings -->
                                <div class="server-section">
                                    <h3>General Settings</h3>
                                    <div class="settings-grid">
                                        <div class="setting-row">
                                            <label for="serverName">Server Name:</label>
                                            <input type="text" id="serverName" class="setting-input" placeholder="Loukai Karaoke">
                                        </div>

                                        <div class="setting-row">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="allowSongRequests" checked>
                                                <span>Allow Song Requests</span>
                                            </label>
                                        </div>

                                        <div class="setting-row">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="requireKJApproval" checked>
                                                <span>Require KJ Approval</span>
                                            </label>
                                        </div>

                                        <div class="setting-row">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="streamVocalsToClients">
                                                <span>Stream Vocals to Clients (LAN only)</span>
                                            </label>
                                        </div>

                                        <div class="setting-row">
                                            <button id="saveServerSettings" class="save-btn">
                                                <span class="material-icons">save</span>
                                                Save Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Admin Password -->
                                <div class="server-section">
                                    <h3>Admin Security</h3>
                                    <div class="settings-grid">
                                        <div class="setting-row">
                                            <label for="adminPassword">Admin Password:</label>
                                            <div class="password-group">
                                                <input type="password" id="adminPassword" class="setting-input" placeholder="Enter new admin password">
                                                <button id="setPasswordBtn" class="action-btn">
                                                    <span class="material-icons">security</span>
                                                    Set Password
                                                </button>
                                            </div>
                                        </div>

                                        <div class="setting-description">
                                            KJs will need this password to access the admin panel
                                        </div>

                                        <div class="setting-row">
                                            <div class="password-status" id="passwordStatus">
                                                No admin password set
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Song Requests -->
                                <div class="server-section">
                                    <h3>Song Requests</h3>
                                    <div class="requests-summary">
                                        <div class="summary-stats">
                                            <div class="stat-item">
                                                <span class="stat-value" id="pendingRequests">0</span>
                                                <span class="stat-label">Pending</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-value" id="totalRequests">0</span>
                                                <span class="stat-label">Total</span>
                                            </div>
                                        </div>
                                        <div class="requests-actions">
                                            <button id="openAdminBtn" class="action-btn">
                                                <span class="material-icons">admin_panel_settings</span>
                                                Open Admin Panel
                                            </button>
                                            <button id="clearRequestsBtn" class="action-btn danger">
                                                <span class="material-icons">delete_sweep</span>
                                                Clear All Requests
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lyrics Editor Tab -->
                    <div id="editor-tab" class="tab-pane">
                        <div class="editor-container">
                            <div class="editor-header">
                                <div class="editor-controls">
                                    <button id="editorSaveBtn" class="editor-btn" disabled>
                                        üíæ Save Changes
                                    </button>
                                    <button id="exportLyricsBtn" class="editor-btn" disabled>
                                        üìÑ Export Lyrics
                                    </button>
                                    <button id="addNewLine" class="editor-btn" disabled>
                                        + Add Line
                                    </button>
                                    <button id="resetLyrics" class="editor-btn" disabled>
                                        ‚Ü∂ Reset
                                    </button>
                                </div>
                                <div class="editor-position">
                                    <span id="editorTime">0:00</span>
                                </div>
                            </div>

                            <div class="editor-content">
                                <div class="editor-column-full">
                                    <div class="lyrics-editor">
                                        <div id="lyricsLines" class="lyrics-lines">
                                            <div class="no-lyrics-message">Load a KAI file to edit lyrics</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="editor-player">
                                <span class="audio-label">IEM</span>
                                <audio id="editorAudio" controls></audio>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span id="statusText">Ready</span>
            </div>
            <div class="status-right">
                <span id="latencyDisplay">Latency: -- ms</span>
                <span id="xrunDisplay">XRuns: 0</span>
            </div>
        </div>
    </div>

    <!-- Song Info Modal -->
    <div id="songInfoModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Song Information</h2>
                <button id="closeSongInfoBtn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="songInfoContent"></div>
            </div>
        </div>
    </div>

    <!-- Visualization Libraries -->
    <script src="lib/butterchurn.min.js"></script>
    <script src="lib/butterchurnPresets.min.js"></script>
    <script>
        console.log('Butterchurn libraries loaded:', {
            butterchurn: typeof window.butterchurn,
            presets: typeof window.butterchurnPresets
        });
        
        // Verify presets are available and debug butterchurn structure
        if (window.butterchurnPresets && typeof window.butterchurnPresets.getPresets === 'function') {
            const presets = window.butterchurnPresets.getPresets();
            console.log('SUCCESS: Butterchurn loaded with', Object.keys(presets).length, 'presets available');
        }
        
        
        // WebGL compatibility test
        try {
            const testCanvas = document.createElement('canvas');
            const testGL = testCanvas.getContext('webgl2') || testCanvas.getContext('webgl');
            console.log('WebGL context test:', {
                hasWebGL: !!testGL,
                version: testGL ? testGL.getParameter(testGL.VERSION) : 'none',
                renderer: testGL ? testGL.getParameter(testGL.RENDERER) : 'none'
            });
        } catch(e) {
            console.error('WebGL test error:', e);
        }

        // Song data listener and save functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up song data listener and save functionality...');
            
            // Listen for song data from main process
            if (window.kaiAPI) {
                window.kaiAPI.song.onData((event, songData) => {
                    console.log('Received song data for save:', songData);
                    window.currentSongData = songData;
                });
            }
            
            // Set up save button handler since renderer scripts don't execute
            const saveBtn = document.getElementById('editorSaveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', async function() {
                    console.log('Save button clicked');
                    
                    if (!window.currentSongData) {
                        console.error('No song data available to save');
                        return;
                    }
                    
                    if (!window.currentSongData.originalFilePath) {
                        console.error('No original file path available for saving');
                        return;
                    }
                    
                    try {
                        // Extract edited lyrics from the DOM using correct selectors
                        const lyricsLines = document.querySelectorAll('.lyric-line-editor');
                        const editedLyrics = [];
                        
                        lyricsLines.forEach((lineElement, index) => {
                            const textElement = lineElement.querySelector('.text-input');
                            const startTimeElement = lineElement.querySelector('.start-time');
                            const endTimeElement = lineElement.querySelector('.end-time');
                            const toggleBtn = lineElement.querySelector('.toggle-btn');
                            
                            if (textElement && startTimeElement && endTimeElement) {
                                const originalLine = window.currentSongData.lyrics[index] || {};
                                const isDisabled = toggleBtn ? toggleBtn.classList.contains('toggle-disabled') : false;
                                
                                editedLyrics.push({
                                    ...originalLine,
                                    text: textElement.value || textElement.textContent || '',
                                    start: parseFloat(startTimeElement.value) || originalLine.start || 0,
                                    end: parseFloat(endTimeElement.value) || originalLine.end || 0,
                                    disabled: isDisabled
                                });
                            }
                        });
                        
                        console.log('Extracted', editedLyrics.length, 'edited lyrics lines');
                        
                        // Update the song data with edited lyrics
                        const updatedSongData = {
                            ...window.currentSongData,
                            lyrics: editedLyrics
                        };
                        
                        console.log('Attempting to save KAI file:', window.currentSongData.originalFilePath);
                        const result = await window.kaiAPI.editor.saveKai(updatedSongData, window.currentSongData.originalFilePath);
                        
                        if (result.success) {
                            console.log('Save successful');
                            // Update the current song data cache
                            window.currentSongData = updatedSongData;
                        } else {
                            console.error('Failed to save changes:', result.error || 'Unknown error');
                        }
                    } catch (error) {
                        console.error('Error saving changes:', error.message);
                    }
                });
            } else {
                console.warn('Save button not found');
            }
        });
    </script>
    
    <!-- App Scripts -->
    <script src="js/settingsAPI.js"></script>
    <script src="js/karaokeRenderer.js"></script>
    <script src="js/audioEngine.js"></script>
    <script src="js/lyricsEditor.js"></script>
    <script src="js/mixer.js"></script>
    <script src="js/player.js"></script>
    <script src="js/coaching.js"></script>
    <script src="js/effects.js"></script>
    <script src="js/requests.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/library.js"></script>
    <script src="js/queue.js"></script>
    <script src="js/main.js"></script>
</body>
</html>